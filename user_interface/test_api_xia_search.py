import json
from test_auxiliary import base_url, set_up_db_for_test, teardown_db_for_test, teardown_browser, setup_browser, logout
from test_auxiliary import login
from bs4 import BeautifulSoup
import pytest
from selenium import webdriver
from bson.objectid import ObjectId


test_data = [
    ("", 4),
    ("testing", 0),
    ("20190228_FullLinerCuPNNL_FullMode_5minpurge_73h", 1),
    ("20190228_FullLinerCuPNNL_FullMode_5minpurge_73", 0),
    ("20190228_FullLinerCuPNNL_FullMode_5minpurge_73h_", 0),
    ("20190228_FullLinerCuPNNL_FullMode_5minpurge_73h, 20210524_NORAXP_FloortileWithTeflon_Wafer_1hpurge_109h", 2),
    ("20190228_FullLinerCuPNNL_FullMode_5minpurge_73h, 20210524_NORAXP_FloortileWithTeflon_Wafer_1hpurge_109h, 20210513_CuSteveM_Wafer_WithTeflon_45minpurge_168h", 3)
]


@pytest.mark.parametrize('query_strings,num_expected_results', test_data)
def test_search_xia(query_strings, num_expected_results):
    browser = prep('TestUser')

    browser.get(base_url + "/simple_search")

    assert browser.current_url == base_url + "/simple_search"

    browser = do_query(browser, query_strings)
    results = browser.page_source

    soup = BeautifulSoup(results, features="html.parser")
    result_docs = soup.find('div', {'id': 'query-results-container'}).find_all('div', {'class': 'collapsible-content'})
    num_docs = len(result_docs)
    assert num_docs == num_expected_results


def do_query(browser, query_string):
    query_element = browser.find_element_by_id("query_value")
    query_element.send_keys(query_string)
    print("query_string", query_string, "__", sep="")
    submit_button = browser.find_element_by_id("submit-query")
    submit_button.click()

    return browser


def prep(username=None):
    teardown_db_for_test()

    docs = _get_docs()
    set_up_db_for_test(docs)

    browser = setup_browser()

    logout(browser)
    if username is not None:
        login(username, browser)

    return browser


def _get_docs():
    docs = [
        {"_id": ObjectId("60d2451d9c373225fca1c8b0"), "Run": "20190228_FullLinerCuPNNL_FullMode_5minpurge_73h", "Sample": "20190228_FullLinerCuPNNL_FullMode_5minpurge_73h", "Date": "20/19/02", "Duration": "67.8191h", "Rise time cut": "60 mus", "Rejected": "first 6 h", "Constant background file": "~/data/xia/PNNL_trayliners/1803_fullruns.root", "Tray background file": "~/data/xia/EmptyTray_RT_wafer.root", "Sample area (cm2)": "", "Vendor": "", "Experiment": "", "Sample material": "", "Readout mode": "", "Purge time": "", "Acquisition time": "", "Energy Range (MeV)": {"0-1": {"Alpha Counts": "0.0", "Total Emissivity (nBq/(cm2)": "0.0+-0.0", "Estimated Constant Counts": "0.1+-0.1", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "-0.6+-0.5", "PLR 90% UL (nBq/cm2)": "9.1"}, "1-2": {"Alpha Counts": "2.0", "Total Emissivity (nBq/(cm2)": "9.3+-6.5", "Estimated Constant Counts": "2.6+-0.6", "Estimated Tray Counts": "0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "-2.4+-7.0", "PLR 90% UL (nBq/cm2)": "13.7"}, "2-3": {"Alpha Counts": "13.4", "Total Emissivity (nBq/(cm2)": "61.1+-16.7", "Estimated Constant Counts": "10.2+-1.1", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "14.7+-17.4", "PLR 90% UL (nBq/cm2)": "54.6"}, "3-4": {"Alpha Counts": "12.7", "Total Emissivity (nBq/(cm2)": "57.6+-16.2", "Estimated Constant Counts": "5.9+-0.8", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "30.6+-16.6", "PLR 90% UL (nBq/cm2)": "68.3"}, "4-5": {"Alpha Counts": "5.4", "Total Emissivity (nBq/(cm2)": "24.5+-10.6", "Estimated Constant Counts": "5.7+-0.8", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "-1.4+-11.2", "PLR 90% UL (nBq/cm2)": "27.3"}, "5-6": {"Alpha Counts": "14.4", "Total Emissivity (nBq/(cm2)": "65.4+-17.2", "Estimated Constant Counts": "17.8+-1.5", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "-15.9+-18.5", "PLR 90% UL (nBq/cm2)": "45.5"}, "6-7": {"Alpha Counts": "23.9", "Total Emissivity (nBq/(cm2)": "108.8+-22.3", "Estimated Constant Counts": "27.1+-1.8", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "-14.5+-23.7", "PLR 90% UL (nBq/cm2)": "63.7"}, "7-8": {"Alpha Counts": "7.0", "Total Emissivity (nBq/(cm2)": "32.0+-12.1", "Estimated Constant Counts": "17.6+-1.5", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "-48.0+-13.8", "PLR 90% UL (nBq/cm2)": "13.7"}, "8-9": {"Alpha Counts": "7.4", "Total Emissivity (nBq/(cm2)": "33.5+-12.3", "Estimated Constant Counts": "8.2+-1.0", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "-3.8+-13.1", "PLR 90% UL (nBq/cm2)": "31.9"}, "9-10": {"Alpha Counts": "8.9", "Total Emissivity (nBq/(cm2)": "40.3+-13.5", "Estimated Constant Counts": "4.7+-0.8", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "19.0+-14.0", "PLR 90% UL (nBq/cm2)": "54.6"}, "2-10": {"Alpha Counts": "93.0", "Total Emissivity (nBq/(cm2)": "423.2+-43.9", "Estimated Constant Counts": "97.2+-3.4", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "-19.3+-46.6", "PLR 90% UL (nBq/cm2)": "172.9"}, "4,8-5,8": {"Alpha Counts": "12.1", "Total Emissivity (nBq/(cm2)": "55.1+-15.8", "Estimated Constant Counts": "12.2+-1.2", "Estimated Tray Counts": "-0.0+-0.0", "BG Subtracted Sample Emissivity (nBq/cm2)": "-0.4+-16.8", "PLR 90% UL (nBq/cm2)": "45.5"}}, "_version": 1},
        {"_id": ObjectId("60d24524403ce8b2d465952b"),"Run": "20210524_NORAXP_FloortileWithTeflon_Wafer_1hpurge_109h","Sample": "20210524_NORAXP_FloortileWithTeflon_Wafer_1hpurge_109h","Date": "20/21/05","Duration": "103.559h","Rise time cut": "60 mus","Rejected": "first 6 h","Constant background file": "/data/local/XIA/ProcessedData/CuPNNL/CuPNNL_Wafer_Merged.root","Tray background file": "20210524_EmptyTray_Wafer_Teflon.root","Sample area (cm2)": "1238.7072","Vendor": "","Experiment": "","Sample material": "","Readout mode": "","Purge time": "","Acquisition time": "","Energy Range (MeV)": {"0-1": {"Alpha Counts": "0.0","Total Emissivity (nBq/(cm2)": "0.0+-0.0","Estimated Constant Counts": "0.0+-0.0","Estimated Tray Counts": "0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "0.0+-0.0","PLR 90% UL (nBq/cm2)": "8.7"},"1-2": {"Alpha Counts": "511.7","Total Emissivity (nBq/(cm2)": "2216.3+-98.0","Estimated Constant Counts": "5.9+-1.5","Estimated Tray Counts": "0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "2190.8+-98.2","PLR 90% UL (nBq/cm2)": "0.0"},"2-3": {"Alpha Counts": "1811.5","Total Emissivity (nBq/(cm2)": "7845.2+-184.3","Estimated Constant Counts": "7.7+-1.8","Estimated Tray Counts": "0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "7812.0+-184.5","PLR 90% UL (nBq/cm2)": "0.0"},"3-4": {"Alpha Counts": "2391.1","Total Emissivity (nBq/(cm2)": "10355.5+-211.8","Estimated Constant Counts": "3.9+-1.3","Estimated Tray Counts": "0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "10338.4+-211.8","PLR 90% UL (nBq/cm2)": "0.0"},"4-5": {"Alpha Counts": "2146.9","Total Emissivity (nBq/(cm2)": "9297.9+-200.7","Estimated Constant Counts": "3.2+-1.1","Estimated Tray Counts": "0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "9284.3+-200.7","PLR 90% UL (nBq/cm2)": "0.0"},"5-6": {"Alpha Counts": "1398.2","Total Emissivity (nBq/(cm2)": "6055.3+-161.9","Estimated Constant Counts": "5.1+-1.4","Estimated Tray Counts": "0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "6033.0+-162.1","PLR 90% UL (nBq/cm2)": "0.0"},"6-7": {"Alpha Counts": "883.0","Total Emissivity (nBq/(cm2)": "3824.2+-128.7","Estimated Constant Counts": "6.8+-1.7","Estimated Tray Counts": "-0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "3795.0+-128.9","PLR 90% UL (nBq/cm2)": "0.0"},"7-8": {"Alpha Counts": "361.0","Total Emissivity (nBq/(cm2)": "1563.6+-82.3","Estimated Constant Counts": "2.0+-0.9","Estimated Tray Counts": "0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "1554.9+-82.4","PLR 90% UL (nBq/cm2)": "1697.7"},"8-9": {"Alpha Counts": "194.5","Total Emissivity (nBq/(cm2)": "842.1+-60.4","Estimated Constant Counts": "5.2+-1.5","Estimated Tray Counts": "-0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "819.4+-60.7","PLR 90% UL (nBq/cm2)": "931.1"},"9-10": {"Alpha Counts": "77.0","Total Emissivity (nBq/(cm2)": "333.7+-38.0","Estimated Constant Counts": "4.4+-1.3","Estimated Tray Counts": "-0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "314.8+-38.4","PLR 90% UL (nBq/cm2)": "389.8"},"2-10": {"Alpha Counts": "9263.2","Total Emissivity (nBq/(cm2)": "40117.6+-416.8","Estimated Constant Counts": "38.3+-3.9","Estimated Tray Counts": "0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "39951.8+-417.2","PLR 90% UL (nBq/cm2)": "0.0"},"4,8-5,8": {"Alpha Counts": "1552.2","Total Emissivity (nBq/(cm2)": "6722.4+-170.6","Estimated Constant Counts": "4.2+-1.3","Estimated Tray Counts": "0.0+-0.0","BG Subtracted Sample Emissivity (nBq/cm2)": "6704.4+-170.7","PLR 90% UL (nBq/cm2)": "0.0"}},"_version": 1},
        {"_id": ObjectId("60d2452be37b7b8a680e8d9c"),"Run": "20210513_CuSteveM_Wafer_WithTeflon_45minpurge_168h","Sample": "20210513_CuSteveM_Wafer_WithTeflon_45minpurge_168h","Date": "20/21/05","Duration": "162.574h","Rise time cut": "60 mus","Rejected": "first 6 h","Constant background file": "/data/local/XIA/ProcessedData/CuPNNL/CuPNNL_Wafer_Merged.root","Tray background file": "20210513_EmptyTray_Wafer_Teflon.root","Sample area (cm2)": "450","Vendor": "","Experiment": "","Sample material": "","Readout mode": "","Purge time": "","Acquisition time": "","Energy Range (MeV)": {"0-1": {"Alpha Counts": "0.0","Total Emissivity (nBq/(cm2)": "0.0+-0.0","Estimated Constant Counts": "0.0+-0.0","Estimated Tray Counts": "0.2+-0.2","BG Subtracted Sample Emissivity (nBq/cm2)": "-1.7+-1.6","PLR 90% UL (nBq/cm2)": "15.2"},"1-2": {"Alpha Counts": "8.2","Total Emissivity (nBq/(cm2)": "62.6+-21.8","Estimated Constant Counts": "9.2+-2.4","Estimated Tray Counts": "0.2+-1.2","BG Subtracted Sample Emissivity (nBq/cm2)": "-8.8+-30.1","PLR 90% UL (nBq/cm2)": "45.6"},"2-3": {"Alpha Counts": "16.8","Total Emissivity (nBq/(cm2)": "127.6+-31.1","Estimated Constant Counts": "12.0+-2.8","Estimated Tray Counts": "0.9+-1.5","BG Subtracted Sample Emissivity (nBq/cm2)": "29.2+-39.2","PLR 90% UL (nBq/cm2)": "98.7"},"3-4": {"Alpha Counts": "11.8","Total Emissivity (nBq/(cm2)": "89.5+-26.1","Estimated Constant Counts": "6.2+-2.0","Estimated Tray Counts": "2.8+-1.3","BG Subtracted Sample Emissivity (nBq/cm2)": "21.1+-31.6","PLR 90% UL (nBq/cm2)": "75.9"},"4-5": {"Alpha Counts": "14.4","Total Emissivity (nBq/(cm2)": "109.2+-28.8","Estimated Constant Counts": "5.0+-1.8","Estimated Tray Counts": "0.2+-0.9","BG Subtracted Sample Emissivity (nBq/cm2)": "70.1+-32.6","PLR 90% UL (nBq/cm2)": "129.1"},"5-6": {"Alpha Counts": "19.4","Total Emissivity (nBq/(cm2)": "147.4+-33.5","Estimated Constant Counts": "8.1+-2.3","Estimated Tray Counts": "0.8+-1.2","BG Subtracted Sample Emissivity (nBq/cm2)": "79.9+-38.8","PLR 90% UL (nBq/cm2)": "151.9"},"6-7": {"Alpha Counts": "22.5","Total Emissivity (nBq/(cm2)": "170.5+-36.0","Estimated Constant Counts": "10.6+-2.6","Estimated Tray Counts": "-0.5+-1.3","BG Subtracted Sample Emissivity (nBq/cm2)": "89.9+-42.2","PLR 90% UL (nBq/cm2)": "167.1"},"7-8": {"Alpha Counts": "1.3","Total Emissivity (nBq/(cm2)": "9.6+-8.5","Estimated Constant Counts": "3.2+-1.4","Estimated Tray Counts": "0.6+-0.8","BG Subtracted Sample Emissivity (nBq/cm2)": "-19.2+-15.1","PLR 90% UL (nBq/cm2)": "15.2"},"8-9": {"Alpha Counts": "11.6","Total Emissivity (nBq/(cm2)": "88.4+-25.9","Estimated Constant Counts": "8.2+-2.3","Estimated Tray Counts": "-1.0+-1.1","BG Subtracted Sample Emissivity (nBq/cm2)": "25.9+-32.2","PLR 90% UL (nBq/cm2)": "91.1"},"9-10": {"Alpha Counts": "4.0","Total Emissivity (nBq/(cm2)": "30.5+-15.2","Estimated Constant Counts": "6.8+-2.1","Estimated Tray Counts": "-1.2+-0.9","BG Subtracted Sample Emissivity (nBq/cm2)": "-21.4+-23.1","PLR 90% UL (nBq/cm2)": "30.4"},"2-10": {"Alpha Counts": "101.7","Total Emissivity (nBq/(cm2)": "772.6+-76.6","Estimated Constant Counts": "60.1+-6.2","Estimated Tray Counts": "2.6+-3.2","BG Subtracted Sample Emissivity (nBq/cm2)": "296.1+-93.1","PLR 90% UL (nBq/cm2)": "440.4"},"4,8-5,8": {"Alpha Counts": "21.6","Total Emissivity (nBq/(cm2)": "164.2+-35.3","Estimated Constant Counts": "6.5+-2.0","Estimated Tray Counts": "1.4+-1.2","BG Subtracted Sample Emissivity (nBq/cm2)": "104.1+-39.6","PLR 90% UL (nBq/cm2)": "174.7"}},"_version": 1},
        {"_id": ObjectId("60d245319c373225fca1c8b2"),"Run": "20210422_PICOL10_notpolished_Wafer_Teflon_1hpurge_336h","Sample": "20210422_PICOL10_notpolished_Wafer_Teflon_1hpurge_336h","Date": "20/21/04","Duration": "329.978h","Rise time cut": "60 mus","Rejected": "first 6 h","Constant background file": "/data/local/XIA/ProcessedData/CuPNNL/CuPNNL_Wafer_Merged.root","Tray background file": "20210422_EmptyTray_Wafer_Teflon.root","Sample area (cm2)": "37.699","Vendor": "","Experiment": "","Sample material": "","Readout mode": "","Purge time": "","Acquisition time": "","Energy Range (MeV)": {"0-1": {"Alpha Counts": "1.0","Total Emissivity (nBq/(cm2)": "44.4+-44.5","Estimated Constant Counts": "0.0+-0.0","Estimated Tray Counts": "1.2+-1.1","BG Subtracted Sample Emissivity (nBq/cm2)": "-7.7+-67.8","PLR 90% UL (nBq/cm2)": "134.0"},"1-2": {"Alpha Counts": "24.8","Total Emissivity (nBq/(cm2)": "1106.7+-222.3","Estimated Constant Counts": "18.8+-4.9","Estimated Tray Counts": "0.9+-6.5","BG Subtracted Sample Emissivity (nBq/cm2)": "228.7+-427.9","PLR 90% UL (nBq/cm2)": "714.6"},"2-3": {"Alpha Counts": "43.0","Total Emissivity (nBq/(cm2)": "1919.1+-292.8","Estimated Constant Counts": "24.4+-5.6","Estimated Tray Counts": "4.9+-7.7","BG Subtracted Sample Emissivity (nBq/cm2)": "611.0+-517.8","PLR 90% UL (nBq/cm2)": "1295.1"},"3-4": {"Alpha Counts": "24.7","Total Emissivity (nBq/(cm2)": "1103.6+-222.0","Estimated Constant Counts": "12.5+-4.0","Estimated Tray Counts": "15.0+-6.7","BG Subtracted Sample Emissivity (nBq/cm2)": "-124.0+-413.2","PLR 90% UL (nBq/cm2)": "446.6"},"4-5": {"Alpha Counts": "18.8","Total Emissivity (nBq/(cm2)": "841.1+-193.8","Estimated Constant Counts": "10.1+-3.6","Estimated Tray Counts": "1.0+-4.8","BG Subtracted Sample Emissivity (nBq/cm2)": "348.4+-332.3","PLR 90% UL (nBq/cm2)": "803.9"},"5-6": {"Alpha Counts": "43.7","Total Emissivity (nBq/(cm2)": "1949.5+-295.1","Estimated Constant Counts": "16.4+-4.6","Estimated Tray Counts": "4.3+-6.4","BG Subtracted Sample Emissivity (nBq/cm2)": "1025.1+-460.3","PLR 90% UL (nBq/cm2)": "1652.4"},"6-7": {"Alpha Counts": "46.4","Total Emissivity (nBq/(cm2)": "2072.8+-304.2","Estimated Constant Counts": "21.5+-5.3","Estimated Tray Counts": "-2.9+-6.7","BG Subtracted Sample Emissivity (nBq/cm2)": "1110.5+-487.2","PLR 90% UL (nBq/cm2)": "1786.4"},"7-8": {"Alpha Counts": "13.6","Total Emissivity (nBq/(cm2)": "605.4+-164.4","Estimated Constant Counts": "6.5+-2.9","Estimated Tray Counts": "3.2+-4.2","BG Subtracted Sample Emissivity (nBq/cm2)": "173.4+-282.1","PLR 90% UL (nBq/cm2)": "580.6"},"8-9": {"Alpha Counts": "27.3","Total Emissivity (nBq/(cm2)": "1218.0+-233.2","Estimated Constant Counts": "16.7+-4.7","Estimated Tray Counts": "-5.3+-5.6","BG Subtracted Sample Emissivity (nBq/cm2)": "471.6+-399.8","PLR 90% UL (nBq/cm2)": "1071.8"},"9-10": {"Alpha Counts": "29.3","Total Emissivity (nBq/(cm2)": "1310.2+-241.9","Estimated Constant Counts": "13.9+-4.2","Estimated Tray Counts": "-6.1+-4.9","BG Subtracted Sample Emissivity (nBq/cm2)": "690.9+-377.0","PLR 90% UL (nBq/cm2)": "1339.8"},"2-10": {"Alpha Counts": "246.7","Total Emissivity (nBq/(cm2)": "11019.6+-701.5","Estimated Constant Counts": "122.0+-12.6","Estimated Tray Counts": "13.9+-16.9","BG Subtracted Sample Emissivity (nBq/cm2)": "4948.3+-1174.8","PLR 90% UL (nBq/cm2)": "6431.0"},"4,8-5,8": {"Alpha Counts": "26.1","Total Emissivity (nBq/(cm2)": "1166.6+-228.3","Estimated Constant Counts": "13.3+-4.1","Estimated Tray Counts": "7.2+-6.1","BG Subtracted Sample Emissivity (nBq/cm2)": "249.6+-402.1","PLR 90% UL (nBq/cm2)": "803.9"}},"_version": 1}
    ]
    return docs
